# A病院 日次採血患者数予測モデル 学習スクリプト 解説

対応ノートブック: `A病院用 学習.ipynb`  
対応Pythonスクリプト: `a_hospital_training.py`

このファイルは、論文中で用いた **A病院の日次採血患者数予測モデル** を再現するための学習パイプラインを説明します。  
実行環境は Google Colab を想定しています。

---

# A 病院 予測モデル学習スクリプト：概要サマリー

* * *

## 1. 日次予測モデル
> **目的**: 1 日の**総採血患者数**を予測する。

### ⚙️ 処理フロー
1. **データ準備**: 以下のファイルをアップロード・ロードします。
   - `採血ログファイル` (列: `実施日`, `処理`)
   - `外来患者数ファイル` (列: `date`, `total_outpatient_count`)
   - `気象データ` (列: `年月日`, `降水量`, `天気概況`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速`)
   ログデータは「終了」レコードにフィルタリング後、日毎に集計します。
2. **特徴量**: カレンダー情報 (`is_holiday`, `月`, `曜日`, `週回数`, `前日祝日フラグ`) と気象情報 (`降水量`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速`, `雨フラグ`, `雪フラグ`) を生成・使用します。
3. **モデル学習**: 2024 年の日次データで`XGBoost`モデルを学習。`GridSearchCV`と 10 分割 CV でハイパーパラメータを最適化します。
4. **評価と可視化**: 2025 年データで精度（RMSE, R2）を評価し、`SHAP`で特徴量の重要度を可視化します。
5. **成果物**:
   * `model_A_daily.json` (モデル)
   * `model_A_daily_scaler.joblib` (スケーラー)
   * `best_params_A_daily.json` (最適パラメータ)

* * *

## 2. 時間帯別 受付数予測モデル
> **目的**: 1 日の中の**30 分単位の受付患者数**を予測する。

### ⚙️ 処理フロー
1. **データ準備**: 日次モデルと同じ 3 ファイルをアップロード・ロードします。
   - `採血ログファイル` (列: `受信`, `処理`)
   - `外来患者数ファイル` (列: `date`, `total_outpatient_count`)
   - `気象データ` (列: `年月日`, `降水量`, `天気概況`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速`)
   ログデータは「終了」レコードの「受信」時間を基に 30 分単位で集計します。
2. **特徴量**:
   * **時間ベース**: `hour`, `minute`, `dayofweek`等。
   * **日次**: 日次モデルと同様のカレンダー・気象情報を各時間帯に付与します。
   * **時系列**: `ラグ特徴量`（直前の受付数）、`移動平均`を追加します。
   * **安定化**: `is_first_slot`等のフラグで予測開始時の挙動を安定化します。
3. **モデル学習**: 2024 年の 30 分枠データで`XGBoost`モデルを学習。`Early Stopping`で過学習を防止します。
4. **評価と可視化**: 2025 年データで精度を評価し、`SHAP`で可視化します。
5. **成果物**:
   * `model_A_timeseries.json` (モデル)
   * `columns_A_timeseries.json` (特徴量リスト)

* * *

## 3. 時間帯別 待ち人数・待ち時間予測モデル
> **目的**: 1 日の中の**30 分単位の待ち人数**と**平均待ち時間**を同時に予測する。

### ⚙️ 処理フロー
1. **データ準備**: 日次・受付数モデルと同じ 3 ファイルをアップロード・ロードします。
   - `採血ログファイル` (列: `受信`, `指示書`, `処理`)
   - `外来患者数ファイル` (列: `date`, `total_outpatient_count`)
   - `気象データ` (列: `年月日`, `降水量`, `天気概況`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速`)
2. **目的変数作成**:
   * **平均待ち時間**: 「受信」と「指示書」の時刻差から算出します。
   * **待ち人数**: 「受付数」と「呼出数」の累積差から算出します。
3. **特徴量**: 受付数モデルと同様の特徴量に加え、「時間帯の受付数」、「前の時間帯の待ち人数」など、待ち行列に特化した情報を追加します。
4. **モデル学習**:
   * **2 つのモデル**（待ち時間予測モデル、待ち人数予測モデル）をそれぞれ独立して学習します。
5. **評価**: 2025 年データで 2 つのモデルの精度を個別に評価します。
6. **成果物**:
   * `model_A_waittime_30min.json` (待ち時間モデル)
   * `model_A_queue_30min.json` (待ち人数モデル)
   * `columns_A_multi_30min.json` (共用の特徴量リスト)

## 実行手順（概要）

1. 必要ライブラリのインストール（`!pip install` セル）。  
2. 採血ログ、外来患者数、気象データをアップロード。  
3. カレンダー特徴量・祝日フラグなどの前処理を実行。  
4. 学習用特徴量の生成と学習・検証データへの分割。  
5. XGBoost モデルの学習と評価（RMSE など）。  
6. 学習済みモデル・スケーラー・特徴量リストを Google Drive 上に保存。

## 入出力のポイント

- **入力データ**
  - 採血ログ CSV
  - 外来患者数 CSV
  - 気象データ CSV（気象庁などの公開データを前処理したもの）
- **出力ファイル（例）**
  - `model_A_daily.json`
  - `model_A_daily_scaler.joblib`
  - `feature_columns_A_daily.json`

これらの出力は、A病院／B病院の予測アプリ側スクリプトから読み込まれます。
