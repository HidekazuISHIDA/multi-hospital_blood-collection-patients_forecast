# A病院 30分単位 待ち人数・待ち時間 同時予測モデル  
`training/a_hospital_training.py` 用データフォーマット仕様

## 概要

このドキュメントは、A病院向けの **30分単位の待ち時間・待ち人数同時予測モデル**  
（`training/a_hospital_training.py`）で使用する入力データ、および  
スクリプト内部で生成される学習データセットのフォーマットを定義します。

モデルの目的は、採血室における **各 30分枠の**

- 平均待ち時間（`avg_wait_minutes`）
- 待ち人数（`queue_size`）

を同時に予測することです。

---

## 1. 入力ファイル一覧

`a_hospital_training.py` は実行時に、以下の 3 ファイルをユーザーにアップロードさせます。

1. 採血ログファイル（CSV, Shift-JIS）
2. 外来患者数ファイル（CSV, UTF-8 BOM）
3. 気象データファイル（CSV, Shift-JIS, 気象庁フォーマット想定）

---

## 2. 採血ログファイル

必須カラム：

| カラム名 | 説明 |
|---------|------|
| **受信** | 採血受付時刻 |
| **指示書** | 採血室呼出時刻 |
| **処理** | 「終了」のレコードのみ使用 |

スクリプトでは、  
`wait_minutes = 指示書 − 受信`（分換算）を作成し、  
**0〜180分以外は除外**。

---

## 3. 外来患者数ファイル

最低限必要なカラム：

| カラム名 | 説明 |
|---------|------|
| **date** | 日付 |
| **total_outpatient_count** | 1日の延べ外来患者数 |

---

## 4. 気象データファイル

気象庁CSVから 8 列を抽出：

| カラム名 | 説明 |
|----------|------|
| date | 日付 |
| 降水量 | 日降水量 |
| 天気概況 | 晴・曇・雨 など |
| 平均気温 | ℃ |
| 最高気温 | ℃ |
| 最低気温 | ℃ |
| 平均湿度 | % |
| 平均風速 | m/s |

追加で生成される特徴量：

- `雨フラグ`
- `雪フラグ`
- `天気カテゴリ`（先頭1文字）

---

## 5. 30分単位 学習データ

### 5.1 集計

| 指標 | 内容 |
|------|------|
| avg_wait_minutes | 呼出時刻ベースの30分平均待ち時間 |
| reception_count | 30分受付数 |
| call_count | 30分呼出数 |

### 5.2 時間特徴量

- hour（時）
- minute（分）
- dayofweek（ダミー化）
- date

### 5.3 日次特徴量

- is_holiday（祝日・土日・年末年始）
- 月
- 週回数
- 前日祝日フラグ
- total_outpatient_count
- 気象量（降水量・気温・湿度・風速）
- 天気カテゴリダミー

### 5.4 待ち人数関連

| カラム | 役割 |
|--------|------|
| net_flow | reception − call |
| queue_size | 時点の推定待ち人数 |
| queue_at_start_of_slot | 30分枠開始時点の待ち人数 |

---

## 6. 学習データ構成

### 6.1 目的変数

- `avg_wait_minutes`
- `queue_size`

### 6.2 説明変数（学習に使用）

上記 2 ターゲットと以下を除くすべて：

- call_count
- net_flow
- date

---

## 7. 学習・検証分割

- **学習データ**：2024年
- **検証データ**：2025年1〜8月

---

## 8. 出力成果物

生成されるファイル：

| ファイル名 | 内容 |
|------------|------|
| `model_A_waittime_30min.json` | 待ち時間モデル |
| `model_A_queue_30min.json` | 待ち人数モデル |
| `columns_A_multi_30min.json` | 特徴量リスト |
| `A_wait_queue_val_results_2025-01_08.csv` | 検証結果 |

---

## 9. 更新について

本 md ファイルは `a_hospital_training.py`（2025年12月版）に対応。  
特徴量追加・仕様変更時は本ファイルも更新すること。


