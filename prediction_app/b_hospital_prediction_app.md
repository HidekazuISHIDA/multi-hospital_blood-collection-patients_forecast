# B病院 採血患者数予測UI スクリプト 解説

対応ノートブック: `B病院用 予測アプリ.ipynb`  
対応Pythonスクリプト: `b_hospital_prediction_app.py`

このファイルは、B病院向けの **日次予測／5営業日予測／時間帯別予測／待ち人数・待ち時間予測** を行うUIスクリプトの解説です。  
`b_hospital_finetuning.py` で学習・保存したモデルを読み込み、論文中の B病院解析パートで用いた推論処理を再現します。

---

## アプリケーションコードの概要

このノートブックには、B病院の採血患者数予測に関連する以下の4つのアプリケーションが含まれています。各アプリケーションは、Google Driveに保存されたモデルファイルと設定ファイルを使用します。

1.  **🏥 B病院 日次採血患者数予測アプリ (Google Drive版)**
    *   **概要:** 特定の日の採血患者数を日次で予測します。
    *   **使用ファイル:**
        *   `model_B_daily_finetuned.json` (XGBoostモデル)
        *   `model_B_daily_scaler.joblib` (特徴量スケーラー)
    *   **入力:** 予測日、延べ外来患者数、天気
    *   **主な使用特徴量 (予測用 `create_features_for_pred` 関数内):**
        *   `月`, `週回数`, `前日祝日フラグ`, `total_outpatient_count`, `雨フラグ`, `雪フラグ`, `曜日_月`～`曜日_土`, (`降水量`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速` - UIからは入力しないがモデルに考慮されている可能性のあるカラム)

2.  **🏥 B病院 採血患者数予測アプリ (5営業日・空白スキップ対応版)**
    *   **概要:** 指定した開始日から次の5営業日間の採血患者数を予測します。延べ外来患者数が入力されていない日はスキップします。
    *   **使用ファイル:**
        *   `model_B_daily_finetuned.json` (XGBoostモデル)
        *   `model_B_daily_scaler.joblib` (特徴量スケーラー)
    *   **入力:** 予測開始日、各営業日の延べ外来患者数
    *   **主な使用特徴量 (予測用 `create_features_for_pred` 関数内 - 上記日次アプリと共通):**
        *   `月`, `週回数`, `前日祝日フラグ`, `total_outpatient_count`, `雨フラグ`, `雪フラグ`, `曜日_月`～`曜日_土`, (`降水量`, `平均気温`, `最高気温`, `最低気温`, `平均湿度`, `平均風速`)

3.  **🏥 B病院 時間帯別 採血患者数予測アプリ**
    *   **概要:** 特定の日の時間帯別（30分ごと）の採血患者数（受付人数）を予測し、グラフで表示します。
    *   **使用ファイル:**
        *   `model_B_timeseries_finetuned.json` (XGBoostモデル)
        *   `columns_B_timeseries.json` (特徴量カラムリスト)
    *   **入力:** 予測対象日、延べ外来患者数、天気予報
    *   **主な使用特徴量 (予測ロジック内):**
        *   `hour`, `minute`, `is_first_slot`, `is_second_slot`, `月`, `週回数`, `前日祝日フラグ`, `total_outpatient_count`, `is_holiday`, `雨フラグ`, `雪フラグ`, `天気カテゴリ_晴`～`天気カテゴリ_薄`, `dayofweek_0`～`dayofweek_6`, `lag_30min`, `lag_60min`, `lag_90min`, `rolling_mean_60min`

4.  **🏥 B病院 待ち人数・待ち時間 統合予測アプリ**
    *   **概要:** 特定の日の時間帯別（30分ごと）の予測受付人数、予測待ち人数、予測平均待ち時間をシミュレーションし、グラフと表で表示します。3つのモデルを使用します。
    *   **使用ファイル:**
        *   `model_B_timeseries_finetuned.json` (受付人数予測モデル)
        *   `columns_B_timeseries.json` (受付人数予測用カラムリスト)
        *   `model_B_waittime_30min_ft.json` (待ち時間予測モデル)
        *   `model_B_queue_30min_ft.json` (待ち人数予測モデル)
        *   `columns_B_multi_30min.json` (待ち時間・待ち人数予測用カラムリスト)
    *   **入力:** 予測対象日、延べ外来患者数、天気予報
    *   **主な使用特徴量:**
        *   **受付人数予測用 (上記時間帯別アプリと共通):** `hour`, `minute`, `is_first_slot`, `is_second_slot`, `月`, `週回数`, `前日祝日フラグ`, `total_outpatient_count`, `is_holiday`, `雨フラグ`, `雪フラグ`, `天気カテゴリ_晴`～`天気カテゴリ_薄`, `dayofweek_0`～`dayofweek_6`, `lag_30min`, `lag_60min`, `lag_90min`, `rolling_mean_60min`
        *   **待ち時間・待ち人数予測用:** `hour`, `minute`, `reception_count` (予測受付人数), `queue_at_start_of_slot` (予測待ち人数), `月`, `週回数`, `前日祝日フラグ`, `total_outpatient_count`, `is_holiday`, `天気カテゴリ_晴`～`天気カテゴリ_薄`, `dayofweek_0`～`dayofweek_6`

これらのアプリケーションは、Google Drive上の指定されたパスにモデルファイルと設定ファイルが正しく配置されていることを前提として動作します。

## 主な機能

- 日次採血患者数の単日予測  
- 5営業日連続予測（空白日・休日のスキップ対応）  
- 時間帯別（30分単位）採血患者数予測（ラグ特徴量による逐次予測）  
- 待ち人数・待ち時間の統合予測（受付状況・採血ブース数などを考慮）  

## 実行方法（概要）

1. Google Colab 上で `b_hospital_prediction_app.py` 相当のコードを実行。  
2. Google Drive をマウントし、B病院向けファインチューニング済みモデルの保存先を指定。  
3. UI 上で、予測対象日・外来患者数・天気・受付条件などを入力。  
4. 予測結果がグラフやテーブルで表示され、業務量・待ち時間の見通しを確認できます。
