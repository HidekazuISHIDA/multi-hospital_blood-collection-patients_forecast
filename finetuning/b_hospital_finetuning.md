# B病院 日次・時間帯別予測モデル ファインチューニング スクリプト 解説

対応ノートブック: `B病院 ファインチューニング.ipynb`  
対応Pythonスクリプト: `b_hospital_finetuning.py`

このファイルは、A病院で学習済みのモデルを **B病院のデータでファインチューニング** する手順を説明します。  
論文中の「外部施設データへの適用およびモデル再学習」の再現を目的としています。

---

### 🏥 B病院 ファインチューニングスクリプトの概要

実行された3つのスクリプトは、A病院で学習済みのモデルを基に、B病院のデータを用いてファインチューニングを行い、日次・時間帯別の採血患者数、および30分単位の待ち時間・待ち人数を予測するモデルを構築・評価・保存するものです。

#### 1. 🏥 B病院 日次予測モデル ファインチューニングスクリプト (セル ID: FzjfApF9zIFl)

*   **目的**: A病院の日次採血患者数予測モデルをB病院データでファインチューニング
*   **必要なアップロードファイル**:
    *   A病院のモデルファイル (`model_A_daily.json`)
    *   A病院のパラメータファイル (`best_params_A_daily.json`)
    *   B病院の採血ログファイル (例: `final_combined_log.csv`)
    *   B病院の外来患者数ファイル (例: `外来患者数.csv`)
    *   気象データ (例: `data.csv`)
*   **使用するB病院データの主な列**:
    *   採血ログ: `実施日`, `処理`
    *   外来患者数: `date`, `total_outpatient_count`
    *   気象データ: `年月日`, `降水量の合計(mm)`, `天気概況(昼：06時〜18時)`, `平均気温(℃)`, `最高気温(℃)`, `最低気温(℃)`, `平均湿度(％)`, `平均風速(m/s)`
*   **生成される成果物**:
    *   B病院日次モデル (`model_B_daily_finetuned.json`)
    *   B病院スケーラー (`model_B_daily_scaler.joblib`)

#### 2. 🏥 B病院 時間帯別モデル ファインチューニングスクリプト (セル ID: zg6dtJJa19x8)

*   **目的**: A病院の時間帯別採血患者数予測モデルをB病院データでファインチューニング
*   **必要なアップロードファイル**:
    *   A病院のモデルファイル (`model_A_timeseries.json`)
    *   A病院の特徴量リスト (`columns_A_timeseries.json`)
    *   B病院の採血ログファイル (例: `final_combined_log.csv`)
    *   B病院の外来患者数ファイル (例: `外来患者数.csv`)
    *   気象データ (例: `data.csv`)
*   **使用するB病院データの主な列**:
    *   採血ログ: `受信`, `処理`
    *   外来患者数: `date`, `total_outpatient_count`
    *   気象データ: `年月日`, `降水量の合計(mm)`, `天気概況(昼：06時〜18時)`, `平均気温(℃)`, `最高気温(℃)`, `最低気温(℃)`, `平均湿度(％)`, `平均風速(m/s)`
*   **生成される成果物**:
    *   B病院時間帯別モデル (`model_B_timeseries_finetuned.json`)
    *   B病院特徴量リスト (`columns_B_timeseries.json`)

#### 3. 🏥 B病院 待ち人数・待ち時間モデル ファインチューニング (セル ID: s7JyyUhz4Ani)

*   **目的**: A病院の待ち時間・待ち人数予測モデルをB病院データでファインチューニング
*   **必要なアップロードファイル**:
    *   A病院の待ち時間モデル (`model_A_waittime_30min.json`)
    *   A病院の待ち人数モデル (`model_A_queue_30min.json`)
    *   A病院の特徴量リスト (`columns_A_multi_30min.json`)
    *   B病院の採血ログファイル (例: `final_combined_log.csv`)
    *   B病院の外来患者数ファイル (例: `外来患者数.csv`)
    *   気象データ (例: `data.csv`)
*   **使用するB病院データの主な列**:
    *   採血ログ: `受信`, `指示書`, `処理`
    *   外来患者数: `date`, `total_outpatient_count`
    *   気象データ: `年月日`, `降水量の合計(mm)`, `天気概況(昼：06時〜18時)`, `平均気温(℃)`, `最高気温(℃)`, `最低気温(℃)`, `平均湿度(％)`, `平均風速(m/s)`
*   **生成される成果物**:
    *   B病院待ち時間モデル (`model_B_waittime_30min_ft.json`)
    *   B病院待ち人数モデル (`model_B_queue_30min_ft.json`)
    *   B病院特徴量リスト (`columns_B_multi_30min.json`)

これらのスクリプトは、アップロードされたB病院の生データを処理し、A病院のモデル構造と特徴量を引き継ぎながらB病院のデータで追加学習を行うことで、B病院に特化した予測モデルを生成します。

## 実行手順（概要）

1. 必要ライブラリのインストール（`japanize-matplotlib`, `jpholiday`, `scikit-learn`, `xgboost`, `shap` 等）。  
2. A病院で事前に学習したモデルファイル・パラメータファイルを Google Drive から読み込み。  
3. B病院の採血ログ・外来患者数・気象データをアップロード。  
4. A病院と同じロジックで特徴量を生成しつつ、B病院固有の分布に合わせて再学習。  
5. 日次モデル・時間帯別モデル・待ち人数／待ち時間モデルをそれぞれ学習・評価。  
6. B病院向けの学習済みモデル一式を Google Drive 上に保存。

## 出力ファイルの例

- `model_B_daily_finetuned.json`  
- `model_B_daily_scaler.joblib`  
- `feature_columns_B_daily.json`  
- 時間帯別モデル用の XGBoost モデル・ラグ特徴量設定ファイル など

これらは `b_hospital_prediction_app.py` から利用されます。
